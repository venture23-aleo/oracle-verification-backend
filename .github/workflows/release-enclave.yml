name: Generate Enclave Key & Release

on:
  push:
    tags:
      - '*'

permissions:
  contents: write

jobs:
  generate_and_release:
    name: Generate Enclave Key and Create Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source code
        uses: actions/checkout@v3

      - name: Run enclave signing key generation script
        run: bash deployment/secrets/generate-enclave-signing-key.sh

      - name: Generate SHA256 checksum
        run: |
          cd deployment/secrets
          shasum -a 256 enclave-signing-key.pem > enclave-signing-key.pem.sha256
          echo "Generated SHA256 checksum:"
          cat enclave-signing-key.pem.sha256

      - name: Upload enclave artifacts (for workflow archive)
        uses: actions/upload-artifact@v3
        with:
          name: enclave-signing-key
          path: |
            deployment/secrets/enclave-signing-key.pem
            deployment/secrets/enclave-signing-key.pem.sha256

      - name: Create GitHub pre-release
        id: create_prerelease
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          release_name: "Pre-release ${{ github.ref_name }}"
          body: |
            Automated pre-release for tag **${{ github.ref_name }}**.

            **Files included:**
            - enclave-signing-key.pem
            - enclave-signing-key.pem.sha256
          draft: false
          prerelease: true

      - name: Upload enclave key to release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: deployment/secrets/enclave-signing-key.pem
          tag: ${{ github.ref_name }}
          overwrite: true

      - name: Upload SHA256 checksum to release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: deployment/secrets/enclave-signing-key.pem.sha256
          tag: ${{ github.ref_name }}
          overwrite: true
